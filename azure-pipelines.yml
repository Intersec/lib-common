strategy:
  matrix:
    ubuntu-18.04:
      imageName: "ubuntu-18.04"
      clang: "clang-9"
      clangCpp: "clang++-9"
      libclangDev: "libclang-9-dev"
      llvmDev: "llvm-9-dev"

    ubuntu-20.04:
      imageName: "ubuntu-20.04"
      clang: "clang"
      clangCpp: "clang++"
      libclangDev: "libclang-dev"
      llvmDev: "llvm-dev"

  maxParallel: 3

pool:
  vmImage: $(imageName)

steps:
  - bash: |
      sudo apt-get update && \
      sudo apt-get install \
        curl \
        python3-dev \
        python3-pip \
        flex \
        gperf \
        pkg-config \
        exuberant-ctags \
        libxml2-dev \
        libssl-dev \
        smitools \
        snmp-mibs-downloader \
        exuberant-ctags \
        valgrind \
        $(clang) \
        $(libclangDev) \
        $(llvmDev)
    displayName: Install system dependencies

  - bash: |
      sudo python3 -m pip install --upgrade pip && \
      sudo python3 -m pip install virtualenv
    displayName: Update pip and install virtualenv

  - script: |
      curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/install-poetry.py | python3 -
      echo "##vso[task.setvariable variable=PATH]${PATH}:$HOME/.poetry/bin"
    displayName: Install poetry

  - bash: |
      sudo curl https://waf.io/waf-2.0.20 -o /usr/local/bin/waf && \
      sudo chmod +x /usr/local/bin/waf && \
      sudo waf --help 2>&1 >/dev/null
    displayName: Install waf

  - script: waf configure
    displayName: Configure with GCC, default

  - script: waf build
    displayName: Compile with GCC, default

  - script: waf check
    displayName: Check with GCC, default

  - script: waf clean
    displayName: Clean-up

  - script: waf configure
    env:
      CC: $(clang)
      CXX: $(clangCpp)
      P: 'asan'
    displayName: Configure with Clang, ASan

  - script: waf build
    displayName: Compile with Clang, ASan

  - script: waf check
    env:
      ASAN_OPTIONS: 'handle_segv=0:detect_leaks=1'
    displayName: Check with Clang, ASan

  - script: waf pylint
    displayName: Check with pylint
